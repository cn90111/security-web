{% extends "base.vue" %}
{% load i18n %}
{% block title %}function home{% endblock title %}

{% block content %}
    {% block hint %}{% endblock hint %}
    <cell cell_title="{% trans '檔案上傳區' %}">
        <div id="loading" class="row" style="display:none">            
            <div class="col-md-1">
                <div class="spinner-border"></div>
            </div>
            <p id="loading_text" class="col-md-11">{% trans '檔案上傳中請稍後' %}</p>
        </div>
        <form id="form_file" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="custom-file center" style="height:80px">
                <input type="file" class="custom-file-input" name="file" id="customFile_csv" accept=".csv" >
                <label class="custom-file-label" for="customFile_csv">{% trans '請選擇將要去識別化的CSV檔案(.csv)' %}</label>
            </div>
        </form>
    </cell>
{% endblock content %}

{% block script %}
    <script>
        page.title = "{% trans '檔案上傳' %}";
        sidebar_highlight('{{ caller }}');
    </script>
    
    <script>
        $(function () {
            var url = "{% url 'check_file_status' %}";
            $.getJSON(url, function (request) {
                if (request == null) {
                    var url = "{% url 'initialize' %}";
                    $.get(url);
                } else if (request.finish == true) {
                    window.location = "{% url 'file_finish' %}";
                } else if (request.finish == false) {
                    window.location = "{% url 'file_running' %}";
                } else {
                    alert("{% trans 'function_home.html finish不符合預期，請通知開發人員，finish = ' %}"+request.finish);
                }
            })
        })        
        
        function isValidFile(file) {
            var type = "." + file.value.split(".")[1];
            if (type == file.accept) {
                return true;
            }
            return false;
        }
        
        function oversize(file) {
            if (file.files[0].size > 4*1024*1024) {
                return true;
            }
            return false;
        }
        
        function reset() {
            $("#customFile_csv").val('');
        }
            
        $("#customFile_csv").on("change", function() {
            var csv_name = $(this).val().split("\\").pop();
            var loading_jquery = $('#loading');
            loading_jquery.show();
            
            window.setTimeout(function() {
                $("#loading_text").text("{% trans '檔案較為龐大，需要較多上傳時間，請稍候' %}");
            }, 5000);
            
            close_alert();
            $(this).siblings(".custom-file-label").addClass("selected").html(csv_name);
            
            if (!csv_name) {
                danger_alert("{% trans '請先選擇檔案' %}");
                loading_jquery.hide();
                return;
            }
            
            if (!isValidFile(document.getElementById('customFile_csv'))) {
                danger_alert("{% trans '檔案類型錯誤' %}");
                loading_jquery.hide();
                return;
            }
            
            if (oversize(document.getElementById('customFile_csv'))) {
                danger_alert("{% trans '檔案過大，不能超過 4 MB' %}");
                loading_jquery.hide();
                return;
            }
            
            let formData = new FormData($('#form_file').get(0));
            $.ajax({
                url: "{{ file_upload_url }}",
                type: 'POST',
                data: formData,
                dataType: 'json',
                contentType: false,
                processData: false,
                success: function () {
                    reset();
                    window.location = '{{ custom_url }}'+csv_name+'/';
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    var jsonObj = JSON.parse(xhr.responseText);
                    danger_alert(jsonObj.message);
                    loading_jquery.hide();
                }
            });
        });
    </script>
{% endblock script %}