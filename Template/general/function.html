<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>{% block title %}title{% endblock title %}</title>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    	<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>
    	<script src="https://ajax.aspnetcdn.com/ajax/bootstrap/4.3.1/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/1000hz-bootstrap-validator/0.11.9/validator.min.js"></script>
	</head>
	<body  style="padding-top:50px;">
        {% include 'navbar.html' %}
        <div class="jumbotron jumbotron-fluid">
            <div class="container">
                {% block content %}
                    <h2>function name</h2>
                    <h5 style="font-weight:bold;color:red">說明：</h5>
                    <p>
                        Description : 
                    </p>
                {% endblock content %}
            </div>
        </div>
    	<div class="container" style="width:inherit;">
            <form id="parameter_form" data-toggle="validator">
                {% csrf_token %}
                {% for field in form %}
                    {% if forloop.counter0|divisibleby:3 %}
                        <div class="form-row">
                    {% endif %}
                    <div class="form-group col-md-4">
                        {{ field.label_tag }}<br>
                        {{ field }}
                        {% if field.help_text %}
                            <small style="color: grey">{{ field.help_text }}</small>
                        {% endif %}
                        {% for error in field.errors %}
                            <p style="color: red">{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% if forloop.last or forloop.counter|divisibleby:3 %}
                        </div>
                    {% endif %}
                {% endfor %}
                <div class="form-row">
                    <div class="form-group col-md-2">
                        <button id="execute" type="button" class="btn btn-primary" style="width:100%">執行</button>
                    </div>
                    <div class="form-group col-md-2">
                        <div onclick="location.href='{% url 'home' %}'" type="button" class="btn btn-primary" style="width:100%">返回主選單</div>
                    </div>
                </div>
            </form>
    	</div>
        <div class="progress-div" style="position:absolute; width:90%;  left:5%;">
            <label> 進度條 </label> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <span id="Check_Txt" style="color:red">執行時間：<span id="Check_i">0小時0分0秒</span>
            <div id="bar" class="progress progress-striped active">
                <div class="progress-bar progress-bar-warning" aria-valuemax="100" aria-valuemin="0" aria-valuenow="0" style="width:0%">
                </div>
            </div>
            <div class="progress-text progress-bar-striped active"  role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em; ">
            </div>
        </div>

    	<script>
            var SetMinute = 0;
            function Check_Time() {
                SetMinute += 1;
                var Check_i = document.getElementById("Check_i");
                var Cal_Hour = Math.floor(SetMinute / 3600);
                var Cal_Minute = Math.floor(Math.floor(SetMinute % 3600) / 60);
                var Cal_Second = SetMinute % 60;
                Check_i.innerHTML = Cal_Hour + "小時" + Cal_Minute + "分" + Cal_Second + "秒";
            }
            
            function reset() {
                SetMinute = 0;
                $('.progress-bar').css('width', 0 + '%');
                $('.progress-bar').text(0 + '%');
                $('.progress-text').text( '目前進度：');
                $('.progress-text').css('width', '100%');
                $('#prog_in').width(0 + '%');
            }   
            
            $(function () {
                $(window).on('beforeunload', function(){
                    $.ajax({
                        type: 'GET',
                        url: '/{{ caller }}/break_program/',
                    });
                });
                $('#execute').on('click', function () {
                    reset()
                    window.scrollTo(0, document.body.scrollHeight)
                    var mm = window.setInterval("Check_Time()", 1000);
                    $('#execute').attr('disabled', 'disabled');
                    console.log("come in {{ caller }}")
                    var log = "";
                    var sitv = setInterval( function () {
                        var prog_url = '/{{ caller }}/show_progress/'
                        $.getJSON(prog_url, function (data) {
                            {# console.log("come in num_progress="+num_progress)#}
                            $('.progress-div').css('visibility', 'visible');
                            $('.progress-bar').css('width', data.num_progress + '%');
                            $('.progress-bar').text(data.num_progress + '%');
                            $('.progress-text').text( '目前進度：'+ data.log );
                            $('.progress-text').css('width', '100%');
                            $('#prog_in').width(data.num_progress + '%');
                        });
                    }, 10000);
                    var url = '/{{ caller }}/Execute/'
                    var data = {csv_name : '{{file_name}}'}
                    {% for field in form %}
                        data['{{field.html_name}}'] = $('#{{field.auto_id }}').val()
                    {% endfor %}
                    $.getJSON(url, data, function (finish) {
                        if (finish == true) {
                            clearInterval(sitv);
                            clearInterval(mm);
                            $('.progress-bar').css('width', '100%');
                            $('.progress-bar').text('100%');
                            $('#bar').removeClass('active');
                            $('.progress-text').text('執行完成');
                            $('#execute').removeAttr('disabled');
                            alert("檔案執行完畢");
                            $(window).off()
                            window.location = '/{{ caller }}/finish/csv_name={{file_name}}';
                        } else {
                            clearInterval(sitv);
                            clearInterval(mm);
                            $('.progress-text').text('執行失敗');
                            $('#execute').removeAttr('disabled');
                            alert('程式執行失敗，請確認上傳檔案符合規格，若多次失敗請聯絡技術人員為您服務，謝謝')
                        }
                    });
                })
            })
        </script>
	</body>
</html>