<!DOCTYPE html>
{% load i18n %}
{% trans '小時' as hour %}
{% trans '分' as minute %}
{% trans '秒' as second %}
{% trans '目前進度：' as completion_rate %}
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>{% block title %}title{% endblock title %}</title>
        {% load static %}
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    	<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>
    	<script src="https://ajax.aspnetcdn.com/ajax/bootstrap/4.3.1/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/1000hz-bootstrap-validator/0.11.9/validator.min.js"></script>
	</head>
	<body  style="padding-top:50px;">
        {% include 'navbar.html' %}
        <div class="jumbotron jumbotron-fluid">
            <div class="container">
                {% block content %}
                    <h2>function name</h2>
                    <h5 style="font-weight:bold;color:red">{% trans '說明：' %}</h5>
                {% endblock content %}
            </div>
        </div>
    	<div class="container" style="width:inherit;">
            <form id="parameter_form" data-toggle="validator">
                {% csrf_token %}
                {% for field in form %}
                    {% if forloop.counter0|divisibleby:3 %}
                        <div class="form-row">
                    {% endif %}
                    <div class="form-group col-md-4">
                        {{ field.label_tag }}<br>
                        {{ field }}
                        {% if field.help_text %}
                            <small style="color: grey">{{ field.help_text }}</small>
                        {% endif %}
                        {% for error in field.errors %}
                            <p style="color: red">{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% if forloop.last or forloop.counter|divisibleby:3 %}
                        </div>
                    {% endif %}
                {% endfor %}
                <div class="form-row">
                    <div class="form-group col-md-2">
                        <button id="execute" type="button" class="btn btn-primary" style="width:100%">{% trans '執行' %}</button>
                    </div>
                    <div class="form-group col-md-2">
                        <div onclick="location.href='{% url 'home' %}'" type="button" class="btn btn-primary" style="width:100%">{% trans '返回主選單' %}</div>
                    </div>
                </div>
            </form>
    	</div>
        <div class="progress-div" style="position:absolute; width:90%;  left:5%;">
            <label> {% trans '進度條' %} </label> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <span id="Check_Txt" style="color:red">{% trans '執行時間：' %}<span id="Check_i">0 {{ hour }} 0 {{ minute }} 0 {{ second }}</span>
            <div id="bar" class="progress progress-striped active">
                <div class="progress-bar progress-bar-warning" aria-valuemax="100" aria-valuemin="0" aria-valuenow="0" style="width:0%">
                </div>
            </div>
            <div class="progress-text progress-bar-striped active"  role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em; ">
            </div>
        </div>

    	<script>
            var SetMinute = 0;
            function Check_Time() {
                SetMinute += 1;
                var Check_i = document.getElementById("Check_i");
                var Cal_Hour = Math.floor(SetMinute / 3600);
                var Cal_Minute = Math.floor(Math.floor(SetMinute % 3600) / 60);
                var Cal_Second = SetMinute % 60;
                Check_i.innerHTML = Cal_Hour + ' {{ hour }} ' + Cal_Minute + ' {{ minute }} ' + Cal_Second + ' {{ second }}';
            }
            
            function reset() {
                SetMinute = 0;
                $('.progress-bar').css('width', 0 + '%');
                $('.progress-bar').text(0 + '%');
                $('.progress-text').text('{{ completion_rate }}');
                $('.progress-text').css('width', '100%');
                $('#prog_in').width(0 + '%');
            }   
            
            $(function () {
                $(window).on('beforeunload', function(){
                    $.ajax({
                        type: 'GET',
                        url: '{{ break_program_url }}',
                    });
                });
                
                $('#execute').on('click', function () {
                    reset()
                    window.scrollTo(0, document.body.scrollHeight)
                    var mm = window.setInterval("Check_Time()", 1000);
                    $('#execute').attr('disabled', 'disabled');
                    var log = "";
                    var sitv = setInterval( function () {
                        var prog_url = '{{ show_progress_url }}'
                        $.getJSON(prog_url, function (data) {
                            {# console.log("come in num_progress="+num_progress)#}
                            $('.progress-div').css('visibility', 'visible');
                            $('.progress-bar').css('width', data.num_progress + '%');
                            $('.progress-bar').text(data.num_progress + '%');
                            $('.progress-text').text( '{{ completion_rate }}'+ data.log );
                            $('.progress-text').css('width', '100%');
                            $('#prog_in').width(data.num_progress + '%');
                        });
                    }, 10000);
                    var url = '{{ execute_url }}'
                    var data = {csv_name : '{{ file_name }}'}
                    {% for field in form %}
                        data['{{ field.html_name }}'] = $('#{{ field.auto_id }}').val()
                    {% endfor %}
                    $.ajax({
                        url: url,
                        type: 'GET',
                        data: data,
                        success: function () {
                            clearInterval(sitv);
                            clearInterval(mm);
                            $('.progress-bar').css('width', '100%');
                            $('.progress-bar').text('100%');
                            $('#bar').removeClass('active');
                            $('.progress-text').text("{% trans '執行完成' %}");
                            $('#execute').removeAttr('disabled');
                            alert("{% trans '檔案執行完畢' %}");
                            $(window).off()
                            window.location = '{{ finish_url }}';
                        },
                        error: function (xhr, ajaxOptions, thrownError) {
                            var jsonObj = JSON.parse(xhr.responseText);
                            clearInterval(sitv);
                            clearInterval(mm);
                            $('.progress-text').text("{% trans '執行失敗' %}");
                            $('#execute').removeAttr('disabled');
                            alert(jsonObj.message);
                        }
                    });
                })
            })
        </script>
	</body>
</html>