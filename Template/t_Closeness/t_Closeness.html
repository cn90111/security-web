<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>t-Closeness</title>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    	<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>
    	<script src="https://ajax.aspnetcdn.com/ajax/bootstrap/4.3.1/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/1000hz-bootstrap-validator/0.11.9/validator.min.js"></script>
	</head>
	<body  style="padding-top:50px;">
        {% include 'navbar.html' %}
        <div class="jumbotron jumbotron-fluid">
            <div class="container">
                <h2>t-Closeness</h2>
                <h5 style="font-weight:bold;color:red">說明： </h5>
                <p>
                    Description : 
                </p>
            </div>
        </div>
    	<div class="container" style="width:inherit;">
            <form id="parameter_form" data-toggle="validator">
                {% csrf_token %}
                <div class="form-row" style="height:110px">
                    <div class="form-group col-md-4">
                        <label for="csv_name_select">CSV_Name：</label>
                        <select class="form-control" id="csv_name_select" >
                            {% for key in s %}
                                <option value="{{ key }}">{{ key }}</option>
                            {%endfor%}
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label for="sa_id">Sensitive Attribute：</label>
                        <input type="text" class="form-control" id="sa_id" placeholder="" required="required" pattern="^[0-9]+$" value="1" disabled="disabled">
                        <div class="help-block with-errors"></div>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="k">K：</label>
                        <input type="text" class="form-control" id="k" placeholder="" required="required" pattern="^[0-9]+$" value="2" disabled="disabled">
                        <div class="help-block with-errors"></div>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="t">T：</label>
                        <input type="text" class="form-control" id="t" placeholder="" value="0.01" disabled="disabled">
                        <div class="help-block with-errors"></div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-2">
                        <button id="T_exe" type="submit" class="btn btn-primary" style="width:100%">執行</button>
                        <!-- <a href="/t_Closeness/Execute_T_closeness/" id="T" class="btn btn-primary" style="width:100%">執行</a>  -->
                    </div>
                    <div class="form-group col-md-2">
                        <div onclick="location.href='/t_Closeness/File_List_Output/'"  type="button" class="btn btn-primary" style="width:100%">已完成檔案列表</div>
                    </div>
                    <div class="form-group col-md-2">
                        <div onclick="location.href='/t_Closeness/'" type="button" class="btn btn-primary" style="width:100%">返回主頁</div>
                    </div>
                    <!-- <a href="/home/DPSyn_Exe/" type="button" class="btn btn-primary">執行</a> -->
                </div>
            </form>
    	</div>
        <!-- 進度條-->
        <div  class="progress-div" style="position:absolute; width:90%;  left:5%;">
            <label> 進度條 </label> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <span id="Check_Txt" style="color:red">執行時間：<span id="Check_i">0小時0分0秒</span>
            <div id="bar" class="progress progress-striped active">
                    <div class="progress-bar progress-bar-warning" aria-valuemax="100" aria-valuemin="0" aria-valuenow="0" style="width:0%">
                    </div>
            </div>
            <div class="progress-text progress-bar-striped active"  role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em; ">
            </div>
        </div>
    	<script>
            var SetMinute = 0;
            var run = true
            function Check_Time() {
                SetMinute += 1;
                var Check_i = document.getElementById("Check_i");
                var Cal_Hour = Math.floor(SetMinute / 3600);
                var Cal_Minute = Math.floor(Math.floor(SetMinute % 3600) / 60);
                var Cal_Second = SetMinute % 60;
                Check_i.innerHTML = Cal_Hour + "小時" + Cal_Minute + "分" + Cal_Second + "秒";
            }
            
            
 			$(function () {
        		$('#T_exe').on('click', function () {               // on() : 做到動態事件綁定
                    var mm = window.setInterval("Check_Time()", 1000);
                    $('#T_exe').attr('disabled', 'disabled');        // 避免多次執行, 所以將按鈕鎖住
                	console.log("come in ")
                    var csv_name_value = document.getElementById("csv_name_select").options[document.getElementById("csv_name_select").selectedIndex].value;
                    var sa_id_value = document.getElementById("sa_id").value;
                    var k_value = document.getElementById("k").value;
                    var t_value = document.getElementById("t").value;
                	var log = "";
                	var sitv = setInterval(function(){             // setInterval() 則是固定延遲了某段時間之後，才去執行對應的程式碼，然後「不斷循環」。 當然也會回傳一個獨立的 timer ID
                    	var prog_url = '/t_Closeness/show_t_closeness/'      // 查詢後台進度的的url，後面會在Django中設置
                    	$.getJSON(prog_url, function(data){
                            {# console.log("come in num_progress="+num_progress)#}
                        	$('.progress-div').css('visibility', 'visible');
                        	$('.progress-bar').css('width', data.num_progress + '%');
                        	$('.progress-bar').text(data.num_progress + '%');
                        	$('.progress-text').text( '目前進度：'+ data.log );
                        	$('.progress-text').css('width', '100%');
            	        	$('#prog_in').width(data.num_progress + '%');     // 更改進度條進度，注意這裡是內層的div
                    	});
                	}, 10000);
            		var thisurl = '/t_Closeness/Execute_t_closeness/'     // 執行的程式url
            		$.getJSON(thisurl,
                        {
                            csv_name : csv_name_value,
                            sa_id : sa_id_value,
                            k : k_value,
                            t : t_value,
                        }, function(num_progress){
            			// ...
                		clearInterval(sitv);                   // 此時請求成功返回成果，結束對後台的查詢
                        clearInterval(mm);
                        $('.progress-bar').css('width', '100%');
                        $('.progress-bar').text('100%');
                        $('#bar').removeClass('active');
                        $('.progress-text').text('執行完成');
                        $('#DPSyn_exe').removeAttr('disabled');
            		});
        		})
			})

		</script>
	</body>
</html>