{% load i18n %}
{% load static %}
<div class="header_word">
    <font id="string_name">被配對對象名稱</font>
</div> 
<div class="modal-body" style="padding:15px 0px 0px 0px;">
    <div>
        <font id="string_introduction" class="en_little_content"></font>
    </div>
    <table class="content_word" style="margin:5px 0px 0px 0px; width:100%">
        <tbody id="string_pair_tbody">
        </tbody>
    </table>
    <div id="column_button">
        <div>
            <img id="custom_add" src="{% static 'img/plus.png' %}" alt="{% trans '新增欄位' %}" width="40"/>
        </div>
    </div>
</div>

<script type="application/javascript">
    var structure_dict = {};
    
    {% if structure_dict %}
        structure_dict = {{ structure_dict|safe }};
    {% endif %}


    function create_string_pair(column_title) {
        $('#string_name').html(column_title);
        set_string_pair(column_title);
    }
    
    function set_string_pair(column_title) {
        var pair_area = document.getElementById('string_pair_tbody');
        var string_element_dict = {{ string_element_dict|safe }};
        var string_element_list = string_element_dict[column_title];
        
        if (!(column_title in structure_dict)) {
            var temp = {};
            for (var element of string_element_list) {
                temp[element] = null;
            }
            structure_dict[column_title] = temp;
        }
        
        var pair_dict = structure_dict[column_title];
        var count = 0;
        pair_area.innerHTML = "";
        for (var element in pair_dict) {
            var tr = pair_area.insertRow(-1);
            var td = tr.insertCell(-1);
            td.innerHTML = '<input type="text" id="column_title_'+ count +'" class="form-control" disabled="disabled">';
            td.innerHTML += '<font>' + element + '</font>';
            td.innerHTML += '</input>';
            td.style = "padding-bottom:5px; padding-right:5px; width:45%;";
            
            td = tr.insertCell(-1);
            td.innerHTML = '<font>' + {% trans '對應' %} + '</font>';
            td.style = "padding-bottom:5px; padding-right:5px; width:5%;"
            
            td = tr.insertCell(-1);
            td.innerHTML = '<input list="select_pair_' + count + '">';
            td.innerHTML += '<span class="custom-select-myarrow">';
            td.innerHTML += '<datalist id="select_pair_' + count + '">';
            for (var pair_element in pair_dict) {
                td.innerHTML += '<option value="' + pair_element + '">;
                td.innerHTML += '<font>';
                td.innerHTML += pair_element;
                td.innerHTML += '</font>';
                td.innerHTML += '</option>';
            }
            td.innerHTML += '</datalist>';
            td.style = "padding-bottom:5px; padding-right:5px; width:45%;";
            
            var select = $('#select_pair_' + count);
            if (pair_dict[element]) {
                select.val(pair_dict[element]);
            }
            select.change(set_string_pair(column_title, element, count));
            count = count + 1;
        }
        $('#custom_add').unbind('click');
        $('#custom_add').click(add_string_pair(column_title));
    }
    
    function set_string_pair(column_title, element, count) {
        var element = $('#column_title_' + count).val();
        var select = $('#select_pair_' + count);
        var pair_dict = structure_dict[column_title];
        console.log(element);
        if (element) {
            pair_dict[element] = select.val();
            structure_dict[column_title] = pair_dict;
            console.log(structure_dict);
        }
    }
    
    function add_string_pair(column_title) {
        var pair_area = document.getElementById('string_pair_tbody');
        var count_id = pair_area.rows.length;
        var tr = pair_area.insertRow(-1);        
        var td = tr.insertCell(-1);
        var pair_dict = structure_dict[column_title];
        
        td.innerHTML = '<input type="text" id="column_title_'+ count_id +'" class="form-control" disabled="disabled">';
        td.innerHTML += '<font>''</font>';
        td.innerHTML += '</input>';
        td.style = "padding-bottom:5px; padding-right:5px; width:45%;";
        
        td = tr.insertCell(-1);
        td.innerHTML = '<font>' + {% trans '對應' %} + '</font>';
        td.style = "padding-bottom:5px; padding-right:5px; width:5%;"
        
        td = tr.insertCell(-1);
        td.innerHTML = '<input list="select_pair_' + count_id + '">';
        td.innerHTML += '<span class="custom-select-myarrow">';
        td.innerHTML += '<datalist id="select_pair_' + count_id + '">';
        for (var pair_element in pair_dict) {
            td.innerHTML += '<option value="' + pair_element + '">;
            td.innerHTML += '<font>';
            td.innerHTML += pair_element;
            td.innerHTML += '</font>';
            td.innerHTML += '</option>';
        }
        td.innerHTML += '</datalist>';
        td.style = "padding-bottom:5px; padding-right:5px; width:45%;";
        
        var string_element = $('#column_title_' + count_id); 
        var select = $('#select_pair_' + count_id);
        string_element.change(add_element_list(column_title, count_id));
        select.change(set_string_pair(column_title, element, count));
        
        td = tr.insertCell(-1);
        td.innerHTML = '<img src="{% static "img/minus.png" %}" alt="{% trans "刪除欄位" %}" width="40" onclick="delete_field('+column_title+', '+count_id+')"/>';
        td.style = "padding-bottom:5px; padding-right:5px; width:5%;"        
    }
    
    function add_element_list(column_title, id) {
        var check_exist = document.getElementById('pair_0_option_'+column_title+'_'+id);
        if(check_exist) {
            delete_element_list(column_title, id)
        }
        var table = document.getElementById(column_title+'_table');
        var element = document.getElementById(column_title+'_element_'+id);
        for (var count = 0; count<table.tBodies[0].rows.length; count++) {
            var datalist = document.
                getElementById(column_title+'_select_pair_'+count);
            datalist.innerHTML += '<option id="pair_'+count+'_option_'+column_title+'_'+id+'" value="'+element.value+'">'+element.value+'</option>'
        }
    }
    
    function delete_field(column_title, delete_id) {
        var table = document.getElementById(column_title+'_table');
        for (var i=delete_id; i<table.tBodies[0].rows.length-1; i++) {
            now_element = document.getElementById(column_title+'_element_'+i);
            next_element = document.getElementById(column_title+'_element_'+(i+1));
            now_element.value = next_element.value;
            now_element = document.getElementById(column_title+'_pair_label_'+i);
            next_element = document.getElementById(column_title+'_pair_label_'+(i+1));
            now_element.value = next_element.value;
            add_element_list(column_title, i);
        }
        delete_element_list(column_title, table.tBodies[0].rows.length-1);
        table.deleteRow(-1);
    }
    
    function delete_element_list(column_title, delete_id) {
        var table = document.getElementById(column_title+'_table');
        if (document.getElementById('pair_0_option_'+column_title+'_'+delete_id)) {
            for (var count = 0; count<table.tBodies[0].rows.length; count++) {
                var datalist = document.
                    getElementById(column_title+'_select_pair_'+count);
                datalist.removeChild(document.getElementById('pair_'+count+'_option_'+column_title+'_'+delete_id))
            }
        }
    }    
</script>